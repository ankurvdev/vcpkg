From 652b48f0af619eba1879342067876f29ad5ae1fc Mon Sep 17 00:00:00 2001
From: Ankur <ankurv@verma>
Date: Sat, 24 Jan 2026 18:05:55 -0800
Subject: [PATCH] lua55.patch

---
 include/sol/compatibility/compat-5.3.h | 6 +++---
 include/sol/compatibility/compat-5.4.h | 8 ++++----
 include/sol/state.hpp                  | 8 +++++++-
 3 files changed, 14 insertions(+), 8 deletions(-)

diff --git a/include/sol/compatibility/compat-5.3.h b/include/sol/compatibility/compat-5.3.h
index 8d32d2d7..bd9dad99 100644
--- a/include/sol/compatibility/compat-5.3.h
+++ b/include/sol/compatibility/compat-5.3.h
@@ -405,11 +405,11 @@ COMPAT53_API void luaL_requiref(lua_State *L, const char *modname,
 
 
 /* other Lua versions */
-#if !defined(LUA_VERSION_NUM) || LUA_VERSION_NUM < 501 || LUA_VERSION_NUM > 504
+#if !defined(LUA_VERSION_NUM) || LUA_VERSION_NUM < 501 || LUA_VERSION_NUM > 505
 
-#  error "unsupported Lua version (i.e. not Lua 5.1, 5.2, 5.3, or 5.4)"
+#  error "unsupported Lua version (i.e. not Lua 5.1, 5.2, 5.3, 5.4 or 5.5)"
 
-#endif /* other Lua versions except 5.1, 5.2, 5.3, and 5.4 */
+#endif /* other Lua versions except 5.1, 5.2, 5.3, 5.4 and 5.5 */
 
 
 
diff --git a/include/sol/compatibility/compat-5.4.h b/include/sol/compatibility/compat-5.4.h
index ae747c64..d11ba9ae 100644
--- a/include/sol/compatibility/compat-5.4.h
+++ b/include/sol/compatibility/compat-5.4.h
@@ -17,15 +17,15 @@ extern "C" {
 }
 #endif
 
-#if defined(LUA_VERSION_NUM) && LUA_VERSION_NUM == 504
+#if defined(LUA_VERSION_NUM) && LUA_VERSION_NUM >= 504
 
 #if !defined(LUA_ERRGCMM)
-/* So Lua 5.4 actually removes this, which breaks sol2...
+/* So Lua 5.4+ actually removes this, which breaks sol2...
  man, this API is quite unstable...!
 */
 #  define LUA_ERRGCMM (LUA_ERRERR + 2)
 #endif /* LUA_ERRGCMM define */
 
-#endif // Lua 5.4 only
+#endif // Lua 5.4+
 
-#endif // NOT_KEPLER_PROJECT_COMPAT54_H_
\ No newline at end of file
+#endif // NOT_KEPLER_PROJECT_COMPAT54_H_
diff --git a/include/sol/state.hpp b/include/sol/state.hpp
index ed2412ed..b05e9741 100644
--- a/include/sol/state.hpp
+++ b/include/sol/state.hpp
@@ -27,6 +27,12 @@
 #include <sol/state_view.hpp>
 #include <sol/thread.hpp>
 
+#if LUA_VERSION_NUM >= 505
+#  define sol_lua_newstate(f, ud) lua_newstate(f, ud, 0)
+#else
+#  define sol_lua_newstate(f, ud) lua_newstate(f, ud)
+#endif
+
 namespace sol {
 
 	class state : private std::unique_ptr<lua_State, detail::state_deleter>, public state_view {
@@ -39,7 +45,7 @@ namespace sol {
 		}
 
 		state(lua_CFunction panic, lua_Alloc alfunc, void* alpointer = nullptr)
-		: unique_base(lua_newstate(alfunc, alpointer)), state_view(unique_base::get()) {
+		: unique_base(sol_lua_newstate(alfunc, alpointer)), state_view(unique_base::get()) {
 			set_default_state(unique_base::get(), panic);
 		}
 
-- 
2.52.0

